var cityList = {
    "lists": {
        "avrist": [{
            "latitude": -6.1710743,
            "longitude": 106.7676787,
            "category_name": "RS. ROYAL PROGRESS INTERNATIONAL",
            "category_code": "Avrist",
            "region_name": "DKI Jakarta",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.1626329,
            "longitude": 106.826826,
            "category_name": "RSIA. HERMINA PODOMORO6",
            "category_code": "Avrist",
            "region_name": "DKI Jakarta",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.1408551,
            "longitude": 106.8166858,
            "category_name": "RS GADING PLUIT",
            "category_code": "Avrist",
            "region_name": "DKI Jakarta",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.2388073,
            "longitude": 106.810696,
            "category_name": "RS. ATMA JAYA",
            "category_code": "Avrist",
            "region_name": "DKI Jakarta",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.238894,
            "longitude": 106.849261,
            "category_name": "RS. ROYAL PROGRESS INTERNATIONAL2",
            "category_code": "Avrist",
            "region_name": "DKI Jakarta",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.220923,
            "longitude": 106.7832011,
            "category_name": "RS. ATMA JAYA2",
            "category_code": "Avrist",
            "region_name": "DKI Jakarta",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.1993611,
            "longitude": 106.8863427,
            "category_name": "RS GADING PLUIT2",
            "category_code": "Avrist",
            "region_name": "DKI Jakarta",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.2038393,
            "longitude": 106.8205089,
            "category_name": "RSIA. HERMINA PODOMORO2",
            "category_code": "Avrist",
            "region_name": "DKI Jakarta",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.2412612,
            "longitude": 106.9936029,
            "category_name": "RSIA. HERMINA PODOMORO3",
            "category_code": "Avrist",
            "region_name": "DKI Jakarta",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }],
        "admedika": [{
            "latitude": -6.2264086,
            "longitude": 106.8323349,
            "category_name": "RSIA. HERMINA PODOMORO5",
            "category_code": "Admedika",
            "region_name": "DKI Jakarta",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        },{
            "latitude": -6.177511,
            "longitude": 106.8000409,
            "category_name": "RSIA. HERMINA PODOMORO",
            "category_code": "admedika",
            "region_name": "DKI Jakarta",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.197726,
            "longitude": 106.6768289,
            "category_name": "RSIA. HERMINA PODOMORO7",
            "category_code": "admedika",
            "region_name": "DKI Jakarta",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.1243535,
            "longitude": 106.8300677,
            "category_name": "RSIA. HERMINA PODOMORO8",
            "category_code": "admedika",
            "region_name": "DKI Jakarta",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.1767764314052,
            "longitude": 106.7886325209,
            "category_name": "RSIA. HERMINA PODOMORO9",
            "category_code": "admedika",
            "region_name": "DKI Jakarta",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, ]
    }
}

//INFO WINDOW//
String.prototype.myFormat = function() {
    var s = this,
        i = arguments.length;

    while (i--) {
        s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
    }
    return s;
};

var markerBauble = '<div class="marker-desc"><h4 class="firstHeading">{0}</h4></div>';
//INFO WINDOW//


//console.log(cityList.lists.avrist[0].latitude);

var map, infoWindow, currentLocation, geocoder, contentString;
var defaultmap = {lat: -6.174448, lng: 106.764759};
var radius = 5; // In Kilometer
var xRadius = ( radius * 2000 );
var zoom = 12;
var bunchAllData = [];
var bunchData = {};
var infowindow = new google.maps.InfoWindow();

//ARRAY FOR TRIGGER INFOWINDOW WITH CLICK FUNCTION
var markers1 = [];
var markers2 = [];

//UNTUK SEARCH MAP
function codeAddress(address) {
    geocoder = new google.maps.Geocoder();
    geocoder.geocode({
        'address': address
    }, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {

            //change geolocation with geometry location
            currentLocation = results[0].geometry.location;

            //MAP OPTIONS
            var myOptions = {
                zoom: zoom,
                center: currentLocation,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                scrollwheel: false
            }

            //REINIT MAP
            map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);

            //ADD MARKER
            var marker = new google.maps.Marker({
                map: map,
                position: currentLocation
            });

            //ADD CIRCLE RADIUS
            var cityCircle = new google.maps.Circle({
              strokeColor: '#542888',
              strokeOpacity: 0.8,
              strokeWeight: 2,
              fillColor: '#542888',
              fillOpacity: 0.35,
              map: map,
              center: currentLocation,
              radius: xRadius
            });
            
            //CALLING JSON ON getList FUNCTION
            getList();
        }
    });
}
//UNTUK SEARCH MAP//

//GET CURRENT LOCATION
function getLocation() {
  if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition, showError);
  } 
  else {
    currentLocation = defaultmap;
    initMap();
  }
}

//IF GEOLOCATION SUCCESS to get the currentLocation
function showPosition(position) {
    //console.log(position);
    currentLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
    initMap();
}

//FUNCTION IF GEOLOCATION NOT ALLOWED, ETC
function showError(error) {
  switch(error.code) {
      case error.PERMISSION_DENIED:
          console.log("User denied the request for Geolocation.")
          currentLocation = defaultmap;
          initMap();
          break;
      case error.POSITION_UNAVAILABLE:
          console.log("Location information is unavailable.")
          currentLocation = defaultmap;
          initMap();
          break;
      case error.TIMEOUT:
          console.log("The request to get user location timed out.")
          currentLocation = defaultmap;
          initMap();
          break;
      case error.UNKNOWN_ERROR:
          console.log("An unknown error occurred.")
          currentLocation = defaultmap;
          initMap();
          break;
  }
}
//GET CURRENT LOCATION//

//INIT MAP FUNCTION
var initMap = function() {

  var mapOptions = {
    center: currentLocation,
    zoom: zoom,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    scrollwheel: false
  };

  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);


  var marker = new google.maps.Marker({
    position: currentLocation,
    map: map
  });

  var cityCircle = new google.maps.Circle({
    strokeColor: '#542888',
    strokeOpacity: 0.8,
    strokeWeight: 2,
    fillColor: '#542888',
    fillOpacity: 0.35,
    map: map,
    center: currentLocation,
    radius: xRadius
  });

  getList();
}, //INIT MAP//

//GET LIST FROM JSON
getList = function() {

  var sortMarkerInRange = [];

  // for all data
  bunchAvristData = [];
  bunchAdmedikaData = [];

  //EACH DATA FROM cityList.lists JSON
  $.each( cityList.lists, function( key, value ) {
    //console.log(value);

    //EACH DATA FROM cityList.lists.avrist and cityList.lists.admedika JSON
    $.each(value, function(k, v) {
      console.log(k, v);

      //LOOPING MARKER FROM JSON//
      var position    = new google.maps.LatLng(v.latitude, v.longitude);
      //console.log(v.latitude, v.longitude);

      CategoryCodelow = v.category_code.toLowerCase();

      if (CategoryCodelow == 'avrist') {
        markers1[k]      = new google.maps.Marker({
            position: position,
            map: map,
            icon: './assets/images/icon-marker.png',
            animation : google.maps.Animation.DROP
        });

        //INFO WINDOW//
        var categoryName   = v.category_name ,
        message = markerBauble.myFormat(categoryName);

        google.maps.event.addListener(markers1[k], 'click', function () {
            infowindow.setContent(message)
            infowindow.open(map, markers1[k])
            $('.gm-style-iw').parent().addClass('gm-style-par')
        });
        //INFO WINDOW//

        v.dataMarker = k;

      }
      else if (CategoryCodelow == 'admedika') {
        markers2[k]      = new google.maps.Marker({
            position: position,
            map: map,
            icon: './assets/images/icon-marker.png',
            animation : google.maps.Animation.DROP
        });

        //INFO WINDOW//
        var categoryName   = v.category_name ,
        message = markerBauble.myFormat(categoryName);

        google.maps.event.addListener(markers2[k], 'click', function () {
            infowindow.setContent(message)
            infowindow.open(map, markers2[k])
            $('.gm-style-iw').parent().addClass('gm-style-par')
        });
        //INFO WINDOW//

        v.dataMarker = k;
        
      }


      //LOOPING MARKER FROM JSON//
      
      //GET DISTANCE FROM CURRENT LOCATION TO EACH MARKER
      var distance_from_location = google.maps.geometry.spherical.computeDistanceBetween(currentLocation, position);
      var distance_in_km = (distance_from_location / 1000).toFixed(1);
      //console.log(distance_in_km + 'km');

      if ((distance_from_location <= xRadius)) {
        // console.log(v.category_code);
        // console.log(v.category_name);

        //add property radius to each data
        v.radius = distance_in_km;

        //Make EACH DATA TO OBJECT
        if(CategoryCodelow === 'avrist') {
          //console.log('avrist');
          // $('.avrist-map-1 #Avrist').append(avrist);
          bunchAvristData.push(v);
        }
        else if(CategoryCodelow === 'admedika') {
          //console.log('admedika');
          // $('.avrist-map-1 #AdMedika').append(avrist);
          bunchAdmedikaData.push(v);
        }
      }

    });

  });

  //SORT DATA FROM SMALL RADIUS TO BIG
  $('.avrist-map-1 #Avrist').html('');
  $('.avrist-map-1 #AdMedika').html('');

  bunchAvristData.sort(function(a, b) {
      return parseFloat(a.radius) - parseFloat(b.radius);
  });
  bunchAdmedikaData.sort(function(a, b) {
      return parseFloat(a.radius) - parseFloat(b.radius);
  });

  //console.log(bunchAvristData);
  //console.log(bunchAdmedikaData);

  //APPEND AVRIST DATA TO ELEMENT AFTER GET SORTED
  $.each(bunchAvristData, function(idx, v){    
    if (idx == 0) {
      var avrist = "<div class=\"pane-box active\" data-tipe=\"avrist\" data-marker=\""+ v.dataMarker + "\">" +
          "<span class=\"font-18 font-xs-14 title\">"+ v.category_name +" </span>" +
          "<br>" +
          "<span class=\"font-14 font-xs-12\">"+ v.address + 
          "<br>"+ v.region_name +
          "<br>"+ v.phone +"</span>" +
          "<span class=\"distance\">"+ v.radius + " km</span>" +
          "<a href="+ v.link +" class=\"btn-violet margin-top-25\">Buka di Google Maps</a>" +
          "</div>";
      $('.avrist-map-1 #Avrist').append(avrist);
    }
    else {
      var avrist = "<div class=\"pane-box\" data-tipe=\"avrist\" data-marker=\""+ v.dataMarker + "\">" +
          "<span class=\"font-18 font-xs-14 title\">"+ v.category_name +" </span>" +
          "<br>" +
          "<span class=\"font-14 font-xs-12\">"+ v.address + 
          "<br>"+ v.region_name +
          "<br>"+ v.phone +"</span>" +
          "<span class=\"distance\">"+ v.radius + " km</span>" +
          "<a href="+ v.link +" class=\"btn-violet margin-top-25\">Buka di Google Maps</a>" +
          "</div>";
      $('.avrist-map-1 #Avrist').append(avrist);
    }
  });

  //APPEND ADMEDIKA DATA TO ELEMENT AFTER GET SORTED
  $.each(bunchAdmedikaData, function(idx, v){    
    if (idx == 0) {
      var avrist = "<div class=\"pane-box active\" data-tipe=\"avrist\" data-marker=\""+ v.dataMarker + "\">" +
          "<span class=\"font-18 font-xs-14 title\">"+ v.category_name +" </span>" +
          "<br>" +
          "<span class=\"font-14 font-xs-12\">"+ v.address + 
          "<br>"+ v.region_name +
          "<br>"+ v.phone +"</span>" +
          "<span class=\"distance\">"+ v.radius + " km</span>" +
          "<a href="+ v.link +" class=\"btn-violet margin-top-25\">Buka di Google Maps</a>" +
          "</div>";
      $('.avrist-map-1 #AdMedika').append(avrist);
    }
    else {
      var avrist = "<div class=\"pane-box\" data-tipe=\"avrist\" data-marker=\""+ v.dataMarker + "\">" +
          "<span class=\"font-18 font-xs-14 title\">"+ v.category_name +" </span>" +
          "<br>" +
          "<span class=\"font-14 font-xs-12\">"+ v.address + 
          "<br>"+ v.region_name +
          "<br>"+ v.phone +"</span>" +
          "<span class=\"distance\">"+ v.radius + " km</span>" +
          "<a href="+ v.link +" class=\"btn-violet margin-top-25\">Buka di Google Maps</a>" +
          "</div>";
      $('.avrist-map-1 #AdMedika').append(avrist);
    }
  });

}

$(document).ready(function(){

  //INIT MAP WITH getLocation FUNCTION
  getLocation();

  //SEARCH FUNCTION
  $('.avrist-map-1 #searchButton').on('click', function(){
    $('.avrist-map-1 #Avrist').empty();
    $('.avrist-map-1 #AdMedika').empty();
    var lokasi = $('#mapSearch').val();
    codeAddress(lokasi);
  });
  $('#mapSearch').on('change', function(){
    $('.avrist-map-1 #Avrist').empty();
    $('.avrist-map-1 #AdMedika').empty();
    var lokasi = $('#mapSearch').val();
    codeAddress(lokasi);
  });
  //SEARCH FUNCTION//

  //ELEMENT CLICK TRIGGER INFO WINDOW OPEN
  $(document).on("click", "#Avrist .pane-box", function(){
      var markerVal = $(this).attr('data-marker');
      google.maps.event.trigger(markers1[markerVal], 'click');
      $('#Avrist .pane-box').removeClass('active');
      $(this).addClass('active');
      if ($(window).width() < 1024) {
        $('html, body').animate({scrollTop:$('#map-canvas').position().top}, 'slow');
      }
  });

  $(document).on("click", "#AdMedika .pane-box", function(){
      var markerVal = $(this).attr('data-marker');
      google.maps.event.trigger(markers2[markerVal], 'click');
      $('#Avrist .pane-box').removeClass('active');
      $(this).addClass('active');
      if ($(window).width() < 1024) {
        $('html, body').animate({scrollTop:$('#map-canvas').position().top}, 'slow');
      }
  });
  //ELEMENT CLICK TRIGGER INFO WINDOW OPEN//

});


