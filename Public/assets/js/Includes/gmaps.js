var cityList = {
    "lists": {
        "avrist": [{
            "latitude": -6.1710743,
            "longitude": 106.7676787,
            "category_name": "RS. ROYAL PROGRESS INTERNATIONAL",
            "category_code": "Avrist",
            "type_name": "ATM",
            "type_code": "ATM",
            "region_name": "DKI Jakarta",
            "title": "TAMAN RATU",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.1626329,
            "longitude": 106.826826,
            "category_name": "RSIA. HERMINA PODOMORO6",
            "category_code": "Avrist",
            "type_name": "ATM",
            "type_code": "ATM",
            "region_name": "DKI Jakarta",
            "title": "PECENONGAN                                   ",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.1408551,
            "longitude": 106.8166858,
            "category_name": "RS GADING PLUIT",
            "category_code": "Avrist",
            "type_name": "ATM",
            "type_code": "ATM",
            "region_name": "DKI Jakarta",
            "title": "GLODOK",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.2388073,
            "longitude": 106.810696,
            "category_name": "RS. ATMA JAYA",
            "category_code": "Avrist",
            "type_name": "ATM",
            "type_code": "ATM",
            "region_name": "DKI Jakarta",
            "title": "WOLTER MONGINSIDI",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.238894,
            "longitude": 106.849261,
            "category_name": "RS. ROYAL PROGRESS INTERNATIONAL2",
            "category_code": "Avrist",
            "type_name": "ATM",
            "type_code": "ATM",
            "region_name": "DKI Jakarta",
            "title": "TEBET",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.220923,
            "longitude": 106.7832011,
            "category_name": "RS. ATMA JAYA2",
            "category_code": "Avrist",
            "type_name": "ATM",
            "type_code": "ATM",
            "region_name": "DKI Jakarta",
            "title": "ITC PERMATA HIJAU",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.1993611,
            "longitude": 106.8863427,
            "category_name": "RS GADING PLUIT2",
            "category_code": "Avrist",
            "type_name": "ATM",
            "type_code": "ATM",
            "region_name": "DKI Jakarta",
            "title": "RAWAMANGUN",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.2038393,
            "longitude": 106.8205089,
            "category_name": "RSIA. HERMINA PODOMORO2",
            "category_code": "Avrist",
            "type_name": "ATM",
            "type_code": "ATM",
            "region_name": "DKI Jakarta",
            "title": "WISMA BNI 46",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.2412612,
            "longitude": 106.9936029,
            "category_name": "RSIA. HERMINA PODOMORO3",
            "category_code": "Avrist",
            "type_name": "ATM",
            "type_code": "ATM",
            "region_name": "DKI Jakarta",
            "title": "AHMAD YANI",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }],
        "admedika": [{
            "latitude": -6.2264086,
            "longitude": 106.8323349,
            "category_name": "RSIA. HERMINA PODOMORO5",
            "category_code": "Admedika",
            "type_name": "Kantor Cabang",
            "type_code": "KC",
            "region_name": "DKI Jakarta",
            "title": "MASS ACQUISITION",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        },{
            "latitude": -6.177511,
            "longitude": 106.8000409,
            "category_name": "RSIA. HERMINA PODOMORO",
            "category_code": "admedika",
            "type_name": "ATM",
            "type_code": "ATM",
            "region_name": "DKI Jakarta",
            "title": "TOMANG",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.197726,
            "longitude": 106.6768289,
            "category_name": "RSIA. HERMINA PODOMORO7",
            "category_code": "admedika",
            "type_name": "ATM",
            "type_code": "ATM",
            "region_name": "DKI Jakarta",
            "title": "KEBON JERUK                                  ",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.1243535,
            "longitude": 106.8300677,
            "category_name": "RSIA. HERMINA PODOMORO8",
            "category_code": "admedika",
            "type_name": "ATM",
            "type_code": "ATM",
            "region_name": "DKI Jakarta",
            "title": "PANTAI INDAH KAPUK",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, {
            "latitude": -6.1767764314052,
            "longitude": 106.7886325209,
            "category_name": "RSIA. HERMINA PODOMORO9",
            "category_code": "admedika",
            "type_name": "ATM",
            "type_code": "ATM",
            "region_name": "DKI Jakarta",
            "title": "CENTRAL PARK",
            "address": "JL. Danau Sunter Utara, Sunter Paradise",
            "image": "https:\/\/www.btpn.com\/website\/static\/img\/orange-pin.png",
            "phone": "021-6459877 ; 6400261",
            "link": "#"
        }, ]
    }
}

//INFO WINDOW//
String.prototype.myFormat = function() {
    var s = this,
        i = arguments.length;

    while (i--) {
        s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
    }
    return s;
};

var markerBauble = '<div class="marker-desc"><h4 class="firstHeading">{0}</h4></div>';

//INFO WINDOW//


//console.log(cityList.lists.avrist[0].latitude);

var map, infoWindow, currentLocation, geocoder, contentString;
var defaultmap = {lat: -6.174448, lng: 106.764759};
var radius = 5; // In Kilometer
var xRadius = ( radius * 2000 );
var zoom = 12;
var bunchAllData = [];
var bunchData = {};
var infowindow = new google.maps.InfoWindow();


//UNTUK SEARCH MAP
function codeAddress(address) {
    geocoder = new google.maps.Geocoder();
    geocoder.geocode({
        'address': address
    }, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
            currentLocation = results[0].geometry.location;

            var myOptions = {
                zoom: zoom,
                center: currentLocation,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                scrollwheel: false
            }
            map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);

            var marker = new google.maps.Marker({
                map: map,
                position: currentLocation
            });

            var cityCircle = new google.maps.Circle({
              strokeColor: '#542888',
              strokeOpacity: 0.8,
              strokeWeight: 2,
              fillColor: '#542888',
              fillOpacity: 0.35,
              map: map,
              center: currentLocation,
              radius: xRadius
            });
            
            
            getList();
        }
    });
}
//UNTUK SEARCH MAP//

//GET CURRENT LOCATION
function getLocation() {
  if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition, showError);
  } 
  else {
    currentLocation = defaultmap;
    initMap();
  }
}

function showPosition(position) {
    console.log(position);
    currentLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
    initMap();
}

function showError(error) {
  switch(error.code) {
      case error.PERMISSION_DENIED:
          console.log("User denied the request for Geolocation.")
          currentLocation = defaultmap;
          initMap();
          break;
      case error.POSITION_UNAVAILABLE:
          console.log("Location information is unavailable.")
          currentLocation = defaultmap;
          initMap();
          break;
      case error.TIMEOUT:
          console.log("The request to get user location timed out.")
          currentLocation = defaultmap;
          initMap();
          break;
      case error.UNKNOWN_ERROR:
          console.log("An unknown error occurred.")
          currentLocation = defaultmap;
          initMap();
          break;
  }
}
//GET CURRENT LOCATION//

//INIT MAP
var initMap = function() {

  var mapOptions = {
    center: currentLocation,
    zoom: zoom,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    scrollwheel: false
  };

  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);


  var marker = new google.maps.Marker({
    position: currentLocation,
    map: map
  });

  var cityCircle = new google.maps.Circle({
    strokeColor: '#542888',
    strokeOpacity: 0.8,
    strokeWeight: 2,
    fillColor: '#542888',
    fillOpacity: 0.35,
    map: map,
    center: currentLocation,
    radius: xRadius
  });

  getList();
}, //INIT MAP//

getList = function() {

  var sortMarkerInRange = [];

  // for all data
  bunchAvristData = [];
  bunchAdmedikaData = [];

  $.each( cityList.lists, function( key, value ) {
    //console.log(value);

    $.each(value, function(k, v) {

      //LOOPING MARKER FROM JSON//
      var position    = new google.maps.LatLng(v.latitude, v.longitude);
      //console.log(v.latitude, v.longitude);
      var marker      = new google.maps.Marker({
          position: position,
          map: map,
          icon: './assets/images/icon-marker.png'
      });

        //INFO WINDOW//
        var categoryName   = v.category_name ,
        message = markerBauble.myFormat(categoryName);

        google.maps.event.addListener(marker, 'click', function () {
            infowindow.setContent(message)
            infowindow.open(map, marker)
            $('.gm-style-iw').parent().addClass('gm-style-par')
        });
        //INFO WINDOW//

      //LOOPING MARKER FROM JSON//
      
      


      var distance_from_location = google.maps.geometry.spherical.computeDistanceBetween(currentLocation, position);
      var distance_in_km = (distance_from_location / 1000).toFixed(1);
      //console.log(distance_in_km + 'km');

      if ((distance_from_location <= xRadius)) {
        // console.log(v.category_code);
        // console.log(v.category_name);

        v.radius = distance_in_km;

        if(v.category_code === 'Avrist') {
          console.log('avrist');
          // $('.avrist-map-1 #Avrist').append(avrist);
          bunchAvristData.push(v);
        }
        else if(v.category_code === 'admedika') {
          console.log('admedika');
          // $('.avrist-map-1 #AdMedika').append(avrist);
          bunchAdmedikaData.push(v);
        }
      }

    });

  });

  $('.avrist-map-1 #Avrist').html('');
  $('.avrist-map-1 #AdMedika').html('');

  bunchAvristData.sort(function(a, b) {
      return parseFloat(a.radius) - parseFloat(b.radius);
  });
  bunchAdmedikaData.sort(function(a, b) {
      return parseFloat(a.radius) - parseFloat(b.radius);
  });

  console.log(bunchAvristData);
  console.log(bunchAdmedikaData);


  $.each(bunchAvristData, function(idx, v){    
    var avrist = "<div class=\"pane-box\" data-tipe=\"avrist\">" +
          "<span class=\"font-18 font-xs-14 title\">"+ v.category_name +" </span>" +
          "<br>" +
          "<span class=\"font-14 font-xs-12\">"+ v.address + 
          "<br>"+ v.region_name +
          "<br>"+ v.phone +"</span>" +
          "<span class=\"distance\">"+ v.radius + " km</span>" +
          "<a href="+ v.link +" class=\"btn-violet margin-top-25\">Buka di Google Maps</a>" +
          "</div>";
      $('.avrist-map-1 #Avrist').append(avrist);
  });

  $.each(bunchAdmedikaData, function(idx, v){    
    var avrist = "<div class=\"pane-box\" data-tipe=\"avrist\">" +
          "<span class=\"font-18 font-xs-14 title\">"+ v.category_name +" </span>" +
          "<br>" +
          "<span class=\"font-14 font-xs-12\">"+ v.address + 
          "<br>"+ v.region_name +
          "<br>"+ v.phone +"</span>" +
          "<span class=\"distance\">"+ v.radius + " km</span>" +
          "<a href="+ v.link +" class=\"btn-violet margin-top-25\">Buka di Google Maps</a>" +
          "</div>";
      $('.avrist-map-1 #AdMedika').append(avrist);
  });

}

$(document).ready(function(){

  getLocation();

  $('.avrist-map-1 #searchButton').on('click', function(){
    $('.avrist-map-1 #Avrist').empty();
    $('.avrist-map-1 #AdMedika').empty();
    var lokasi = $('#mapSearch').val();
    codeAddress(lokasi);
  });
  $('#mapSearch').on('change', function(){
    $('.avrist-map-1 #Avrist').empty();
    $('.avrist-map-1 #AdMedika').empty();
    var lokasi = $('#mapSearch').val();
    codeAddress(lokasi);
  });

});


